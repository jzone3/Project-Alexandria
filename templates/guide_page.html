{% extends "base.html" %}
{% block title %}{{ guide.title }} - Project Alexandria{% endblock %}

{% block nav_links %}
	<li><a href="/">Home</a></li>
	<li class="active"><a href="/guides">Guides</a></li>
	{% if signed_in %}
		<li><a href="/upload">Upload</a></li>
	{% endif %}
	<li><a href="/about">About</a></li>
	<li><a href="/contact">Contact</a></li>
{% endblock %}

{% block page_content %}
	<div class="container" >
		<div class="well" style="overflow:hidden;">

			<div class="row-fluid">
				<div class="span8">
					<h1>
						{{ guide.title }} 
						{% if deletable %}
						<br/>
						<button class="btn btn-inverse" id ="deletebtn" type="button">
							<span id="deletetext">Delete Guide</span>
						</button>
						<span style='font-size: 12px;color: #BBB;'>There are {{ diff }} / 24 hours left to delete this guide <a rel="tooltip" data-placement="right" title="You only have 24 hours to delete your guide. After 24 hours, you will not be able to remove your study guide from Project Alexandria." class="tooltips"> <i class="icon-question-sign"></i></a></span>
						{% endif %}
					</h1>
					{% if guide.user_created == '[deleted]' %}
						<h3><em>by </em>{{ guide.user_created }}</h3>
					{% else %}
						<h3><em>by <a href="/user/{{ guide.user_created }}">{{ guide.user_created }}</a></em></h3>
					{% endif %}
					<h6>{{ guide.subject }} - {{ guide.teacher }}</h6> 
					<h5>
					    <a href="#" class="bookmarkbtn" id="{{ guide.blob_key }}" style="margin-left:-1px;"><i class="icon-bookmark"></i> Bookmark</a>	
						<span> | </span>					    
					    <a href="{{ dl_link }}"><i class="icon-download-alt"></i> Download</a>
					    <span> | </span>

						{% if guide.edit_url and signed_in %}
						<a href="{{ guide.edit_url }}" target="_blank">
							<i class="icon-cloud"></i> Edit on Google Docs
						</a>
						{% elif not signed_in %}
						<span style="color:#ACACAC;">							
							<i class="icon-cloud"></i> Please <a href="#login" data-toggle="modal">log in</a> to edit this guide						
						</span>	
						{% else %}
						<span style="color:#ACACAC;">							
							<i class="icon-cloud"></i> Edit on Google Docs						
						</span>	
						{% endif %} 							
					</h5>
				</div>
				<div class="span4">
					<div class="btn-group btn-group-vertical answer" data-toggle="buttons-radio" id="{{ guide.key() }}" style="float:right;margin-top:10px;">
					  <button class="btn btn-large vote up {%if user and user.username in guide.up_users%}active{%endif%}"><i class="icon-caret-up"></i></button>
					  <span rel="tooltip" id="tip_{{ guide.key()}}" class="tooltips" title="You already voted for this guide. <a href='#' class='tiplink' onclick=&quot;$('#tip_{{guide.key()}}').tooltip('hide')&quot;>&times;</a>" data-placement="left" style="float:left;"></span>
					  <button class="btn btn-large vote down {%if user and user.username in guide.down_users%}active{%endif%}"><i class="icon-caret-down"></i></button>
					</div>
					<div style="position:relative;top:90px;left:40px;text-align:right;text-shadow:1px 1px 1px #B6B6B6;"><h6 id="votes_{{ guide.key() }}">{{ votes }} Votes</h6></div>
					{% if signed_in %}
					<button type="button" class="btn btn-danger btn-small" data-loading-text="Reporting..." style="position:relative;float:right;left:40px;top:85px;" id="reportbtn">
						<span id="reporttext" rel="tooltip" data-placement="bottom" title="Is this guide cheating or plagiarism?<br> Let us know, you'll stay anonymous.">Report Guide</span>
					</button>
					<script>
						$('#reporttext').tooltip();
					</script>
					{% endif %}
					{% if reported %}
					<script type="text/javascript">
						$('#reportbtn').button('loading');
						$('#reportbtn').html('Reported. Thank you!')
					</script>
					{% endif %}
				</div>
			</div>
			<hr>

			

			<div style="float:right">
				<script type="text/javascript"><!--
					google_ad_client = "ca-pub-1213608668776384";
					/* Ad1 */
					google_ad_slot = "3236695387";
					google_ad_width = 336;
					google_ad_height = 280;
					//-->
					</script>
					<script type="text/javascript"
					src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
				</script>
			</div>
			
			<script src="/static/js/Date.min.js"></script>
			<script src="/static/js/date.format.js"></script>
			<div style="float:left;width:500px;">
				<div id="comments">
					<h4 style="margin-bottom:12px;">Comments</h4>
		
					{% if not comments %}
						<div id="nocomments" style="height:30px;">
							<h5 style="font-weight:normal;"><em>No comments here!<em></h5>
							<br/>
						</div>
					{% else %}
						{% for comment in comments %}
						<div>
							<div style="word-break:normal;">
								<a href="/user/{{comment.user.username}}">{{comment.user.username}}</a>: 
								{{comment.comment}}
							</div>
							<div style="width:100%;">
								<span class="datetime" id="{{comment.date_created}}"></span>
								<span class="comment_btns" style="float:right;">
									<span><!-- Left blank intentionally --></span> 
									<span>
										<span>{{comment.upvotes}}</span>
										<span><a href="#" class="comment_plus" id="{{comment.key()}}"><i class="icon-caret-up"></i></a></span>
									</span>
									 | 
									<span>
										<span>{{comment.downvotes}}</span>
										<span><a href="#" class="comment_minus" id="{{comment.key()}}"><i class="icon-caret-down"></i></a></span>
									</span>

									{% if user and user.key() == comment.user.key() %}
									 | 
									<a href="#" class="comment_delete" id="{{comment.key()}}">Delete</a>
									{% endif %}
								</span>
							</div>
						</div>
						{% endfor %}
					{% endif %}
				</div>

				<form style="float:left;margin-top:10px;">
					<textarea id="comment" placeholder="Write a comment" style="height:70px;"></textarea>
					<br/>
					{% if admin %}
						<select name="comment_user" id="comment_user">
							{% for user in fake_users %}
							<option value="{{user}}">{{user}}</option>
							{% endfor %}
						</select>
					{% endif %}
					<button type="button" class="btn" id="commentsubmit">Submit</button>
				</form>
			</div>

		
		</div> 
	</div>


	<script type="text/javascript">
	$('.comment_plus').click(function(e) {
		e.preventDefault();

	    var id = $(this).attr('id');
	    var vote_type = 'up';
	    var th = $(this);
	    var p_up = parseInt(th.parent().prev().text());
	    var p_down = parseInt(th.parent().parent().next().text());

	    $.ajax({
		    type:'POST', 
		    url:'/comment_vote', 
		    data:'id=' + id + '&type=' + vote_type,
		    success: function(response) {
				if (response == 'voted') {
					th.parent().parent().prev().html('You already upvoted.');
				} else if (response == 'signin') {
					$('#login').modal('show');
				} else if (response == 'up') {
					th.parent().prev().html(p_up + 1);
				} else if (response == 'double_up') {
					th.parent().prev().html(p_up + 1);
					// selects the adjacent downvotes number
					th.parent().parent().next().children(':first-child').html(p_down - 1);
				}		        
		    }
		});
	});

	$('.comment_minus').click(function(e) {
		e.preventDefault();

	    var id = $(this).attr('id');
	    var vote_type = 'down';
	    var th = $(this);
	    var p_down = parseInt(th.parent().prev().text());
	    var p_up = parseInt(th.parent().parent().prev().text());

	    $.ajax({
		    type:'POST', 
		    url:'/comment_vote', 
		    data:'id=' + id + '&type=' + vote_type,
		    success: function(response) {
				if (response == 'voted') {
					th.parent().parent().prev().prev().html('You already downvoted.');
				} else if (response == 'signin') {
					$('#login').modal('show');
				} else if (response == 'down') {
					th.parent().prev().html(p_down + 1);
				} else if (response == 'double_down') {
					th.parent().prev().html(p_down + 1);
					// selects the adjacent upvotes number
					th.parent().parent().prev().children(':first-child').html(p_up - 1);
				}		        
		    }
		});
	});

	$('a.comment_delete').click(function(e) {
		e.preventDefault();

		var id = $(this).attr('id');
		if ($(this).hasClass('confirm')) {
			// delete
			var th = $(this);
			$.ajax({
			    type:'POST', 
			    url:'/delete_comment', 
			    data:'id=' + id,
			    success: function(response) {
					th.parent().parent().parent().hide('slow');
			    }
			});
		} else {
			// confirmation
			$(this).html('Confirm delete?');
			$(this).addClass('confirm');
		}

	});
			
	function parseDate(date) {
		var array1 = date.split("-");
		var d = new Date();
		d.setUTCFullYear(parseInt(array1[0]));
		d.setUTCMonth(parseInt(array1[1])-1);
		var array2 = array1[2].split(" ");
		d.setUTCDate(parseInt(array2[0]));
		var array3 = array2[1].split(":");
		d.setUTCHours(parseInt(array3[0]));
		d.setUTCMinutes(parseInt(array3[1].split(".")[0]));
		return d;
	}
		
	$(document).ready(function() {
		// print all dates for comments
		$('.datetime').each(function(index){
			var dt = parseDate($('.datetime')[index].id);
			// format time and date string
			var time = dateFormat(dt, "h:MMTT mmm dS, yyyy");
			// print to page
			$(this).html(time);
			$(this).css({'font-style':'italic', 'font-weight':'normal', 'font-size':'12px'})
		})
	});


	function toggleBookmark() {
		$('a.bookmarkbtn').toggleClass('bmd');
		if ( $('a.bookmarkbtn').hasClass('bmd') ) {
			$('a.bookmarkbtn').fadeOut(300, function() {
				$('a.bookmarkbtn').html('<i class="icon-bookmark-empty"></i> Remove Bookmark');
				$('a.bookmarkbtn').fadeIn(270);
			});
			
		}
		else {
			$('a.bookmarkbtn').fadeOut(300, function() {
				$('a.bookmarkbtn').html("<i class='icon-bookmark'></i> Bookmark" );
				$('a.bookmarkbtn').fadeIn(270);
			});
			
		}
	}
	
	$(document).ready(function() {
		if ( "{{ bookmarked }}" == "True" ) {
			$('a.bookmarkbtn').addClass('bmd');
			$('a.bookmarkbtn').html('<i class="icon-bookmark-empty"></i> Remove Bookmark');
		}
	});
	

	$('a.bookmarkbtn').click(function() {
		if ("{{ signed_in }}" != "True") {
			$('#login').modal('show');
			return;
		}
		var id = $(this).attr('id');
		
		if ( $('a.bookmarkbtn').hasClass('bmd') ) {
			$.post('/removebookmark', {id: id});
		}
		else {
			$.post('/addbookmark', {id: id});
		}
		toggleBookmark();
	});
	
	function str_votes(n) {
		n += '';
		if (n>0){ 
			n = '+' + n;
		}
		return n;
	}

	$('div.answer button.vote').click(function() {
	    var id = $(this).parents('div.answer').attr('id');
	    var vote_type = $(this).hasClass('up') ? 'up' : 'down';
	    var previous_votes = $("td.score_" + id).attr('id');

	    $.ajax({
		    type:'POST', 
		    url:'/vote', 
		    data:'id=' + id + '&type=' + vote_type + '&username=' + "{{ username }}",
		    success: function(response) {
				if (response == 'voted') {
					// if already voted
					$("#tip_" + id).tooltip('show');
				} else if (response == 'signin') {
					$('#login').modal('show');
				} else {
					prev = parseInt($('#votes_' + id).text());
					after = prev + parseInt(response);
					$('#votes_' + id).html(str_votes(after) + ' Votes');
					if (vote_type == 'up'){
						$('#votes_' + id).css({'color':'#14BB14'});
					} else {
						$('#votes_' + id).css({'color':'red'});
					}
				}		        
		    }
		});
	});

    $('#reportbtn').click(function() {
    	if ($('#reportbtn').hasClass('confirm')){
 			// if button already confirmed
			$('#reportbtn').button('loading');
	    	$.ajax({
	    		type:'POST',
	    		url:'/report',
	    		data:'blob_key=' + '{{ guide.blob_key }}',
	    		success: function(response) {
	    			$('#reportbtn').html(response)
	    		}
	    	});
		} else {
			// confirmation text
			$('#reportbtn').addClass('confirm');
			$('#reporttext').slideUp('slow', function (){
				$('#reporttext').html('Are you sure?');
			});
			$('#reporttext').slideDown('slow');
		}
    });

    $('#commentsubmit').click(function() {
    	comment = $('#comment').val();

    	// admin username selection
    	{% if admin %}
    		user = $('#comment_user').val();
    	{% endif %}
    	// end admin 

	    $.ajax({
		    type:'POST', 
		    url:'/comment', 
		    data:'key={{guide.key()}}' + '&comment=' + comment {% if admin %}+'&user='+user{% endif %},
		    success: function(response) {
		    	if (response != 'False' && response != 'signin') {
					$('#comment').val('');
					var username = response.split(',')[0];
					var dt_str = response.split(',')[1];
					var dt = parseDate(dt_str);

					// format time and date string
					var time = dateFormat(dt, "h:MMTT mmm dS, yyyy");

					// comment_id needed to add comment with $.text() later
					var comment_id = 'comment_' + Date.parse(Date())

					// construct html for the comment and date
					var link = '<div style="word-break:normal;"><a href="/user/'+username+'">'+username+'</a>: <span id="'+comment_id+'"></span></div>'
					var dt = '<div class="width:100%"><span class="datetime" style="font-style:italic;font-weight:normal;font-size:12px;">'+time+'</span>'
					var refresh = '<span class="comment_btns" style="float:right"><a href="#" onclick="location.reload()">Refresh</a></span></div>'

					// print to page
					$('#nocomments').hide('slow');
					$('#comments').append(link+dt+refresh);
					$('#'+comment_id).text(comment);
		    	} else if (response == 'signin') {
		    		$('#login').modal('show');
		    	}				
		    }
		});
	});
</script>

{% if deletable %}
<script>    
	$('#deletebtn').click(function() {
		if ($('#deletebtn').hasClass('confirm')){
			key = "{{ guide.key() }}";
			$.ajax({
	    		type:'POST',
	    		url:'/guide/delete',
	    		data:'key=' + key,
	    		success: function(response) {
	    			alert(response);
	    			window.location = "/guides";
	    		}
	    	});
		} else {
			$('#deletebtn').addClass('confirm');
			$('#deletetext').slideUp('slow', function (){
				$('#deletetext').html('Are you sure?');
			});			
			$('#deletetext').slideDown('slow');
		}
	});
</script>
{% endif %}

{% endblock %}